# 键盘输入过程

![按键输入过程 (3)](https://raw.githubusercontent.com/mowang111/image-hosting/master/img/%E6%8C%89%E9%94%AE%E8%BE%93%E5%85%A5%E8%BF%87%E7%A8%8B%20(3).png)

## 硬件中断

## 硬件级映射

## 系统级映射

### MSG结构

在Windows操作系统中，虚拟键码和字符消息被封装到了`MSG`结构中，然后发送给应用程序。

以下是`MSG`结构的定义：

```c
typedef struct tagMSG {
  HWND   hwnd;        // 窗口句柄
  UINT   message;     // 消息标识符（例如，WM_CHAR, WM_KEYDOWN等）
  WPARAM wParam;      // 附加消息信息。对于键盘消息，这通常是虚拟键码或字符值
  LPARAM lParam;      // 附加消息信息。它包含关于击键的其他信息，如重复计数、键状态等
  DWORD  time;        // 消息时间戳
  POINT  pt;          // 鼠标在产生此消息时的位置
} MSG, *PMSG, *NPMSG, *LPMSG;
```

当应用程序通过如`GetMessage`、`PeekMessage`等函数从其消息队列中获取消息时，它会收到填充了上述数据的`MSG`结构。

例如，对于`WM_KEYDOWN`消息：

- `message`成员会包含`WM_KEYDOWN`。
- `wParam`成员会包含虚拟键码，表示被按下的键。
- `lParam`成员会包含有关击键的其他信息，如是否按下了ALT键、击键是否是自动重复等。

对于`WM_CHAR`消息：

- `message`成员会包含`WM_CHAR`。
- `wParam`成员会包含字符值。
- `lParam`成员同样会包含有关击键的其他信息。

这种方式允许应用程序在其窗口过程中处理各种消息，并根据需要对它们作出反应。

## 消息发送

当一个消息生成并需要被派送时，系统会：

### 1. 确定目标窗口

决定将消息放入哪个应用程序的线程的消息队列基于一系列的因素和规则，具体来说：

1. **窗口焦点**: 当用户在一个窗口中进行操作，如点击或键入，该窗口通常拥有“键盘焦点”。键盘相关的消息（如`WM_KEYDOWN`、`WM_CHAR`等）将被发送到当前拥有键盘焦点的窗口。这是通过窗口管理器来维护的。
2. **鼠标位置**: 对于鼠标相关的消息（如`WM_LBUTTONDOWN`），它们通常会被发送到鼠标指针当前所在的窗口。也就是说，鼠标消息的目标窗口是基于鼠标光标的屏幕位置来确定的。
3. **窗口层次结构**: 在窗口层次结构中，一个窗口可能有多个子窗口。在某些情况下，如果子窗口没有处理某个消息，该消息可能会“冒泡”到其父窗口。
4. **消息发送**: 有些消息是由应用程序明确使用`SendMessage`或`PostMessage`函数发送的，而不是由用户操作生成的。在这些情况下，消息的目标窗口由发送消息时指定。
5. **线程关联**: 在Windows中，每个线程都有自己的消息队列。窗口是与创建它的线程关联的。当一个消息确定发送到某个窗口时，它实际上被放入与该窗口关联的线程的消息队列中。因此，决定将消息放入哪个应用程序的消息队列实际上是基于窗口所属线程的。
6. **活动窗口与非活动窗口**: 活动窗口（或前台窗口）是用户当前与之交互的窗口。键盘输入、激活消息、系统命令等通常发送到活动窗口。但某些消息（如鼠标消息）可以发送到非活动窗口。

系统的窗口管理器和消息机制会处理这些规则和条件，以确保每个消息都发送到适当的窗口和相应的消息队列。

### 2. 查找与该窗口关联的线程

### 3. 将`MSG`消息放入那个线程的消息队列中

## 应用程序处理MSG消息

`TranslateMessage`函数是由应用程序调用的。它的主要目的是将某些键盘消息（例如，按键消息）`转换为字符消息。当应用程序从其消息队列中获取消息时，它会调用`TranslateMessage`来处理这些消息。

这里是一个典型的Windows消息循环，你可以看到`TranslateMessage`如何被使用：

```
cCopy codeMSG msg;
while (GetMessage(&msg, NULL, 0, 0))
{
    TranslateMessage(&msg);
    DispatchMessage(&msg);
}
```

在上面的循环中：

1. `GetMessage`函数从应用程序的消息队列中获取下一个消息。
2. `TranslateMessage`负责转换键盘消息。例如，如果用户按下了一个键，这个函数会将`WM_KEYDOWN`消息转换为`WM_CHAR`消息（如果适用）。
3. `DispatchMessage`将消息发送到相应的窗口过程进行进一步处理。

所以，简单来说，`TranslateMessage`是由应用程序在其消息循环中调用的，而不是由操作系统自动调用的。