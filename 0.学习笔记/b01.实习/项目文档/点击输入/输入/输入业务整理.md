# 输入业务整理

## 指令梳理

涉及**两种指令**：**填写输入框（win/web）**和 **键盘输入**

影刀目前支持**五种输入方法**：模拟人工输入、剪切板输入、自动化接口输入、CDP输入、驱动输入。

支持Web元素、ACC元素、UIA元素、Java元素、Haly元素、SAP元素、CV元素

### 填写输入框指令

![image-20230823111841832](https://raw.githubusercontent.com/mowang111/image-hosting/master/img/image-20230823111841832.png)

| 输入方法       | 兼容性                                 | 稳定性（使用1~5五个等级表示，5表示稳定性最强） | 速度 | 热键支持 | 底层实现方式                    | 追加输入实现        | 备注                                                         |
| -------------- | -------------------------------------- | ---------------------------------------------- | ---- | -------- | ------------------------------- | ------------------- | ------------------------------------------------------------ |
| 模拟人工输入   | 100%                                   | 4                                              | 慢   | 是       | 直接使用autoit发送              | ctrl A + DEL        | sap模拟输入的时候无法输入中文，暂时都用非模拟输入（自动化接口输入）<br />CEF均使用CDP代替模拟人工输入 |
| 剪切板输入     | 100%                                   | 3                                              | 快   | 否       | 设置剪切板，autoit 发送ctrl + V | ctrl A + DEL        |                                                              |
| 自动化接口输入 | 99％ - 网页应用程序60％ - 桌面应用程序 | 5                                              | 快   | 否       | 不同元素实现不同，见下表        | 发送原文本+输入文本 | Chrome和Edge自动化接口输入本质采用了高级别的CDP输入方法      |
| CDP输入        | Chrome, Edge                           | 5                                              | 快   | 是       |                                 | 调用CDP接口         | 使用CDP底层级别的指令，未暴露出来，Chrome静默运行时自动使用  |
| 驱动输入       | 80%网银                                | 5                                              | 快   |          |                                 |                     |                                                              |

#### 输入方法

##### Autoit输入

Autoit有两种输入方式，Send和ControlSend

**`Send`** 会向当前活动（或者说获得焦点的）窗口发送键盘消息。如果在 **`Send`** 函数执行时，用户切换了活动窗口，那么输入可能会发送到错误的窗口。

**`ControlSend`** 可以将输入发送到指定的窗口和控件，而不管它是否是活动的。这就避免了用户切换窗口导致输入错误的问题。另外，**`ControlSend`** 也支持在后台窗口中输入文本。（目前Chrome和Edge是中的模拟人工输入是使用ControlSend）

```csharp
Send ( "keys" [, flag = 0] )
ControlSend ( "title", "text", controlID, "string" [, flag = 0] )
```

##### CDP输入实现方式

![image-20230823111109169](https://raw.githubusercontent.com/mowang111/image-hosting/master/img/image-20230823111109169.png)



### 键盘输入指令

![image-20230823112243980](https://raw.githubusercontent.com/mowang111/image-hosting/master/img/image-20230823112243980.png)

| 输入方法 | 兼容性 | 稳定性（使用1~5五个等级表示，5表示稳定性最强） | 速度 | 热键支持 | 底层实现方式       |
| -------- | ------ | ---------------------------------------------- | ---- | -------- | ------------------ |
| 普通输入 | 100%   | 4                                              | 慢   | 是       | 直接使用autoit发送 |
| 驱动输入 |        | 5                                              | 快   | 是       |                    |

## 底层梳理

![image-20230823142340030](https://raw.githubusercontent.com/mowang111/image-hosting/master/img/image-20230823142340030.png)

### 系统级映射

![image-20230823142158507](https://raw.githubusercontent.com/mowang111/image-hosting/master/img/image-20230823142158507.png)

### MSG结构

在Windows操作系统中，虚拟键码和字符消息被封装到了`MSG`结构中，然后发送给应用程序。

以下是`MSG`结构的定义：

```c
typedef struct tagMSG {
  HWND   hwnd;        // 窗口句柄
  UINT   message;     // 消息标识符（例如，WM_CHAR, WM_KEYDOWN等）
  WPARAM wParam;      // 附加消息信息。对于键盘消息，这通常是虚拟键码或字符值
  LPARAM lParam;      // 附加消息信息。它包含关于击键的其他信息，如重复计数、键状态等
  DWORD  time;        // 消息时间戳
  POINT  pt;          // 鼠标在产生此消息时的位置
} MSG, *PMSG, *NPMSG, *LPMSG;
```

当应用程序通过如`GetMessage`、`PeekMessage`等函数从其消息队列中获取消息时，它会收到填充了上述数据的`MSG`结构。

例如，对于`WM_KEYDOWN`消息：

- `message`成员会包含`WM_KEYDOWN`。
- `wParam`成员会包含虚拟键码，表示被按下的键。
- `lParam`成员会包含有关击键的其他信息，如是否按下了ALT键、击键是否是自动重复等。

对于`WM_CHAR`消息：

- `message`成员会包含`WM_CHAR`。
- `wParam`成员会包含字符值。
- `lParam`成员同样会包含有关击键的其他信息。

这种方式允许应用程序在其窗口过程中处理各种消息，并根据需要对它们作出反应。

### 消息队列处理

  ![image-20230822153650510](https://raw.githubusercontent.com/mowang111/image-hosting/master/img/image-20230822153650510.png)

```c++
MSG Msg = { 0 }；
while (GetMessage(&Msg)){
    TranslateMessage(&Msg); //将虚拟键消息转化为字符消息
    DispatchMessage(&Msg); //分发一个消息给对应窗口过程
}
```

# 现有问题

## 稳定性问题

目前的填写输入框部分存在偶发性的输入错误的情况

| **输入问题**                          | **实际场景**                                                 |
| ------------------------------------- | ------------------------------------------------------------ |
| 本来输入ctrl + v，结果错误输入v       | 电脑负载过大的时候，在Edge浏览器中，使用剪切板输入错误输入v<br />https://devops.aliyun.com/projex/bug/KHD-3325# 《【鼠标键盘】模拟输入使用 auto it，导致输入 a、v 问题》 |
| 本来输入ctrl + a，结果错误输入a       | 1. 当有向日葵等远程软件存在的时候，会被劫持ctrl按键<br />2. 其他原因待确认，可能和错误输入v的场景类似<br />https://devops.aliyun.com/projex/request/CAYX-417# 《填写输入框  键盘显示打了一个a,并未实际填入输入框》 |
| 输入的时候乱码，像是shift按键没有抬起 | https://devops.aliyun.com/projex/request/CAYX-563# 《指令“填写输入框”填写英文和字母出现乱码问题》 |
| JAVA输入TAB按键有输入漏的情况         | https://devops.aliyun.com/projex/request/CAYX-490# 《NC JAVA表格中键盘输入指令连续输入TAB，会漏TAB》 |
| 模拟人工输入到一半输入不了            | 1. 一种原因是其他软件抢了输入的焦点，比如观远的一个案例，wps一直发送通知，导致网页输入的焦点一直被抢<br />https://devops.aliyun.com/projex/request/CAYX-90# 《新通知频繁抢焦点导致输入不了（观远）》 |

## 功能性问题

| **需要增加的功能**                                           | **链接**                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 【填写输入框的内容做隐藏】：加一个选项，发版的时候自动隐藏内容 | https://www.yingdao.com/community/detaildiscuss?id=6b586c66-315a-4743-b335-a9fe25522ba0 |
| 【输入前的点击操作增加双击】：有些输入框需要双击才能输入     | https://www.yingdao.com/community/detaildiscuss?id=67f66e3e-8222-4ce2-9bd9-2786d7610c24 |
| 【暴露快捷键操作】：将输入的内置的快捷键操作暴露出来，交给用户选择，比如输入前的快捷键ctrl + A/不操作等等，输入结束之后的快捷键ctrl + ENTER/ENTER/END/不操作等等 | https://www.yingdao.com/community/detaildiscuss?id=0f799ec9-84f5-4f76-aa1b-2d0ba807568e |
| 【强制加载美式键盘不生效】：部分窗口不处理切换输入法的消息，这时候可能需要给用户一个提示 | https://www.yingdao.com/community/detaildiscuss?id=5ed14526-0fd4-476a-a9f7-059fbb96e28b |
| 【优化剪切板输入提示】：其他软件抢占剪切板的时候会卡住，填写输入框的时候就会有延时，这时候需要优化提示，表明其他软件正在占用剪切板，请等待 | https://www.yingdao.com/community/detaildiscuss?id=3e841132-6c3f-43a4-a84e-a0e91373d70c |
| 【输入时增加禁用鼠标键盘的功能，防止误触】                   | https://www.yingdao.com/community/detaildiscuss?id=6e9a5211-d55f-441e-a184-c61c6a8fe537 |
| 【优化输入报错】：部分自动化接口输入无实际效果，需要优化，目测只能通过业务侧增加提示客户使用时手动检查 | https://www.yingdao.com/community/detaildiscuss?id=6e9a5211-d55f-441e-a184-c61c6a8fe537 |
| 【增加输入方式】：目前只有追加输入，可以增加一下其他输入方式，比如前置输入，或者正则匹配替换输入 | https://www.yingdao.com/community/detaildiscuss?id=ad9b7196-5c61-4d7a-8c13-e5c69152ea02 |

# 友商对比

| 功能            | uipath                                   | uibot | 影刀           | 备注                                                         |
| --------------- | ---------------------------------------- | ----- | -------------- | ------------------------------------------------------------ |
| 模拟人工输入    | 有，对应硬件事件                         |       | 有             |                                                              |
| 剪切板输入      |                                          |       | 有             |                                                              |
| 自动化接口输入  | 有，对应模拟键入                         |       | 有             |                                                              |
| Chrome的CDP输入 | 有，对应Chromium Api，仅支持Chrome和Edge |       | 有，未暴露出来 | 影刀只有在网页静默运行的时候才会使用CDP输入                  |
| 驱动输入        | 无                                       |       | 有             | 适用于大部分网银                                             |
| 等待元素出现    | 有                                       |       | 有，需要优化   |                                                              |
| **自动校验**    | 有                                       | 有    | 无             | uipath的自动校验（可选）：如果输入框不是想要的内容，会自动重复三次，直到报错<br />只能校验不是追加的情况下才能正常校验，如果输入框原先存在内容，选择自动校验必定会报错 |
|                 |                                          |       |                |                                                              |

# 场景用例

## 一般场景

一般的场景需要覆盖的点：

| 不同的软件                    | 不同的输入方式 | 是否追加输入 | 输入内容      | 是否包含快捷键 | 按键间隔 | 鼠标点击位置 |
| ----------------------------- | -------------- | ------------ | ------------- | -------------- | -------- | ------------ |
| Web(Chrome, Edge, IE, 紫鸟等) | 模拟人工       | 是           | 中英文        | 是             | 10ms     | 中心点       |
| JAVA                          | 剪切板         | 否           | 特殊字符{}，@ | 否             | 20ms     | 随机位置     |
| SAP                           | 自动化接口     |              |               |                | 50ms     | 自定义       |
| Haly                          |                |              |               |                | 100ms    |              |
| uia                           |                |              |               |                | 1000ms   |              |
| acc                           |                |              |               |                |          |              |



## 特殊场景

为了保证点击输入的正确性，需要保证两个因素——**操作对象和操作动作**

- 操作对象
  - 操作对象的正确性（不能操作成了其他对象）
    
  - 操作对象属性改变（可见性，可操作性）
- 操作动作
  - 发送动作的正确性
  - 动作处理不符合预期
    - 输入法层面
    - 窗口层面
    - 网页层面
    - 后台层面

输入错误的特殊场景就需要影响上面的因素中考虑

| 特殊场景错误因素                         | 特殊场景                                                     | 制造特殊场景物料 |
| ---------------------------------------- | ------------------------------------------------------------ | ---------------- |
| 操作对象——操作对象的正确性               | **输入框很小**，输入前点击的时候没有聚焦                     |                  |
| 操作对象——操作对象属性改变（可见性）     | **输入前的鼠标移动操作导致新的弹出的对象覆盖了原本的操作对象** |                  |
| 操作动作——动作处理不符合预期——输入法层面 | **安装各种三方输入法**                                       |                  |
| 操作动作——动作处理不符合预期——窗口层面   | **电脑负载过大**，导致窗口处理消息错误，比如CTRL+V, 直接处理成了v字符<br />这里 |                  |
| 操作动作——动作处理不符合预期——网页层面   | 比如**Gmail网页**填写新邮件的收件人，如果输入框原本为空，输入ctrl+A，会导致失焦 |                  |
| 操作动作——动作处理不符合预期——后台层面   | 比如有些网页的话，自动化接口输入，不会被后台识别             |                  |
|                                          |                                                              |                  |
|                                          |                                                              |                  |
|                                          |                                                              |                  |



# TODO

+ [ ] 用例编写，特殊场景制造
+ [ ] 加上自动校验的功能
+ [ ] 将ControlSend换成Send做稳定性实验
+ [ ] 研究Chrome对于窗口消息处理的机制
+ [ ] 研究uipath对应的输入方式
