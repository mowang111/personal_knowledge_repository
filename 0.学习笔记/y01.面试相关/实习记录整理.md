# 实习经历

影刀是做rpa的产品，主要做桌面，手机的自动化，可以对比如网页，桌面软件进行自动化操作，通过拖拉拽进行流程自动化的编写。

我实习是在客户端的引擎组，主要负责输入部分的优化，具体包括填写桌面软件或者网页输入框。

包括对输入框元素的定位，就是构建自动化树，以及具体输入相应的字符

我做的主要是优化层面的

+ 目前其中一个输入方法，模拟人工输入，它的核心其实是利用一个免费的闭源软件来做的，但是线上会出现不稳定的问题，比如出现输入错误的情况，而且输入错误也不会报错，这个问题看起来很小，但是出现问题就会很严重，比如自动化退款的时候，输入错了数字就会造成客户的资损，线上也出现过一个比较严重的输入问题，造成了客户录入信息的错误，花费了不少时间才改回来
+ 所以需要对输入部分做稳定性优化
  + 首先是收集线上的输入错误的问题，常见的比如输入多了一个a, 小写输入成了大写等等
  + 对这些问题，有一个比较大的痛点就是它们都是偶现的，很难复现，很可能就是因为机器环境的不同，操作过程中的某个因素造成的问题。
    + 其中一个方法是进行头脑风暴，想可以复现的特殊场景，这里用到了chatgpt，终于找到了一个可以复现的特殊场景，就是电脑负载过大的时候，输入ctrl + v，错误输入成了v，这个一开始是怀疑同步的问题，ctrldown v ctrlup的顺序错了，后面加入了延时操作修复了这个问题
    + 另一个严谨的方法就是对输入这部分逻辑进行整体的梳理，包括业务上的逻辑，比如元素定位，切换输入法，一些延时操作，以及还有技术上的，比如底层的输入逻辑
      + 按键按下导致硬件中断，键盘驱动会将这个扫描码转换成虚拟键码，然后虚拟键码会被通过操作系统发送到被激活的窗口的消息队列，窗口的线程从消息队列取出按键消息，通过translatemessage转换成字符消息，然后通过disatchmessage发送到消息队列中。
        + 这个过程的分析对解决问题还是很重要的，比如之前提到的闭源软件其实是有两种输入方法的，一个是send，一个是controlsend，分别是发送全局消息直接让操作系统进行下一步的消息分发，一个是直接指定窗口发送按键消息，按照道理说controlsend会更稳定一点，软件的文档里也是这样说的，我们也是这样用的，但是实际上controlsend发送ctrl+v消息的时候，会将ctrldown + v + ctrlup分别发送到chrome窗口，如果电脑的负载过大，chrome消息处理会出现问题，造成translatemessage翻译v这个虚拟按键的时候忽略了ctrl的修饰，而send是像全局发送的消息，ctrl按键按下的状态是操作系统保持下来的，chrome处理的时候不会出问题，这个我也做实验验证了，所以之后输入的部分改进也是靠这一点更加稳定
      + 处理对按键底层逻辑的分析，还有对那个闭源输入软件本身的分析，因为它不是开源的，所以需要进行逆向分析，现学了一些逆向分析的知识，利用ida分析软件的核心dll，这里也用了chatgpt进行辅助分析，分析它在输入前进行了哪些操作，比如controlsend也会判断窗口是否挂起，做了一些操作防止输入过程中被人为按键中断
  + 参考上面的分析，写了一个c++的输入dll，专门进行输入，不断进行稳定性优化，不过目前阶段还不可能上产品，毕竟需要很长时间的稳定性测试。



## COM技术

背景
微软Office 产品经理的一个需求：希望能够在一个 word 中可视化的编辑、操作 一个 Excel 文档，便于市场宣传。
当点击这个excel对象时，能够在word内部编辑这个文档。这个文档可以保存在word中，也可以单独保存在一个单独的excel文件中
为了做到实现这个功能， 需要做到几点

+ excel 对象 要按照 word 指定的规范进行开发，也就是实现 word 需要的接口。word 才能识别出一个对象是否可以嵌入到文档中，才能调用这些对象的功能
+ word 外部的对象（excel）对象要能够读取存储在word文件中的数据，展示出来，在保存时要能够保存在word文件中

微软将上面的功能实现后

+ 将第一个技术提炼出来，进化成为了 COM 
+ 将第二个技术提炼出来称为 复合文档，这个技术几乎只有微软自己在使用

**com 是什么？**Component
	com对象是以二进制组件发布的，不是用源文件发布。需要实现二进制级别的兼容。

​	com组件是基于对象的，而不是像Windows api 一样是面向过程的。

​	com定义了如何查询一个com对象支持的功能，以及对应的组件的生命周期的管理。
**com 的优点**

+ COM 是一种规范，任何语言、系统都可以实现com规范，无论是 c、c++、c#、java等语言
+ 可以很方便的升级已有的组件，只要新的组件提供的接口与老的组件一致
+ 可以复用已有的组件，目前win上提供了大量的com组件，而且windows很多api都是以com的方式提供的
  是语言无关的，任何语言都可以复用com开发的组件。
+ com还可以是进程或者是分布式的，其它进程这种对程序的稳定性有很好的提升，分布式可以很好的扩容

**com如何使用**

- 所有的COM对象都必须继承自IUknown接口，并且实现对应的语义

- + AddRef
  + Release
  + QueryInterface

**Com 自动化所必须的 IDispatch 接口**

- IUknown 接口的缺点

- - 使用时一般都需要 com 组件的开发商，提供头文件（这里面定义了用户所需的函数）
  - 用户想要调用组件的某个接口，必须使用 com 组件开发商提供的 组件 头文件，编写如下的代码。

- - - CoCreateInstance
    - QueryInterface
    - xxx->Func	

这些代码必须在编译之前就编写好，从而一些动态的脚本语言无法使用组件提供的功能。微软就此引入了 IDispatch 接口，通过此接口，可以获得 组件 所实现的 方法名与id，而后又提供了 给定id 就可以调用对应方法的函数，从而使得脚本语言也可以很方便的使用com组件
