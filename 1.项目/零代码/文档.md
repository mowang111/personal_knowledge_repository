## 整体思路

### 目的

该阶段的目标是实现和大彩软件VisualTFT同样的串口更新功能，具体任务是将屏幕的工程文件下载到屏幕上，下载完成后，屏幕应当正常运行工程的各种功能，下载的文件分为两种，一种是整个工程的更新，另一种是特定图片的更新。

### 方法

#### 测试的硬件设备

测试屏幕的型号为医用级DC80480M070_2111_OT

#### 下载工程文件和图片文件

测试的工程为远鸿_project，该工程适合七寸屏幕，共包含十一个工程画面，编译后的文件结构如下图

![image-20210828165042726](C:\Users\11547\AppData\Roaming\Typora\typora-user-images\image-20210828165042726.png)

测试图片下载的工程仅有一个画面只包含一张图片，该图片的id为0，替换的图片为五张，大小分别为5832 bytes,19608 bytes, 115363 bytes, 219647 bytes, 383188 bytes, 将工程中的图片依次替换为这些图片，并进行测试。

![image-20210829152122860](C:\Users\11547\AppData\Roaming\Typora\typora-user-images\image-20210829152122860.png)



#### 相关软件使用和对应平台

首先，进行串口更新的两种方法分别是使用VisualTFT软件和使用C语言代码编写下载逻辑，其中VisualTFT软件为大彩公司提供的配套软件，在Win10系统运行，而C语言代码则在Win10系统下Ubuntu虚拟机中编译运行。测试辅助软件为BusHound，该软件为大彩提供的串口数据抓取软件，便于对串口数据进行分析。一致性数据对比软件使用Beyond Compare，该软件可以便于对文本数据进行对比。

#### 下载流程

对于使用VisualTFT软件下载，只需要将工程文件导入软件中，通过图形化界面操作编译下载即可。

对于使用C语言代码下载，需要将下载流程可归纳为三个部分，即打开串口文件，以及串口数据的发送与接收，其中默认发送的串口数据的波特率为9600，故使用open函数打开串口文件时填入的波特率参数为9600，发送数据即可直接使用write函数对串口进行操作，接收数据可用read函数直接进行数据读取。

##### 下载前的准备

首先需要做下载前的准备工作，即发送串口连接确认的命令，如果连接成功，设备会返回连接成功的确认包，并且发出“滴”一声，接着如果是下载整个工程，则可以加入格式化的命令，将屏幕之前的工程文件清除，之后下载前需要发送字符串axrcekgdyhtsunqwpjbvifomzl使屏幕切换到大彩指令模式。

##### 文件遍历

需要对文件夹中的所用文件进行下载，所以需要使用递归遍历所有文件夹，当查找到文件时，开始对应的文件下载。

##### 文件下载

随后即可发送文件下载的命令，下载命令以EE FB开头，接着是下载包的大小（取2052，2个字节，高位在前），波特率（如果提升波特率，则填写相应波特率/100，2个字节，高位在前，如果不修改当前波特率，则设置为0），文件大小（4个字节，高位在前），文件在屏幕中存放的路径（以"3:"开头，如"2:/bin/image.bin"），校验码（CRC16，校验从FB开始的数据），以FF FC FF FF结尾，发送完该命令后，等待屏幕返回的下载确认应答，紧接着即可发送文件数据，将文件数据分成多个数据包发送，每个数据包大小为2052个字节，其中前两位为sn和~sn，用来标明数据包的序列号，每次发送完成，等待应答字节(sn+1)和~(sn+1)。等待全部文件下载完成后，发送下载完成指令，结束工程更新。

##### 编译运行

C语言代码编写好后，使用gcc编译运行。

### 结果

#### 一致性分析

一致性分析是指在主要功能和使用方面，分析用代码下载和用VisualTFT软件下载是否相同，其又分成两个方面，一个是下载一致性，即工程文件的下载过程是否相同以及测试是否都可下载成功，另一个是事件响应一致性，即下载成功后，屏幕功能是否可以正常使用，使用结果是否相同。对于整个工程的更新和图片的更新，每个测试都使用了两种波特率——9600和115200，每种波特率测试三组数据进行对比。

##### 下载一致性分析

1. 整个工程的更新

   在整个工程的更新中，包括了文件下载的顺序，数据下发，最终结果的一致性，首先对于文件的下载顺序，经过几次测试，使用VisualTFT软件下载，每次文件下载顺序都是相同的，使用代码下载，每次下载顺序也是不变的，但是两者的文件下载顺序并不相同，经测试证明，工程最终的下载结果与文件下载的顺序没有关系，故下载顺序不同没有影响。对于数据的下发，使用Bus Hound软件进行串口数据的抓取导出为文本文件后，使用Beyond Compare软件进行文本对比，由于两者下载顺序的不同，不能简单地对比整个文本，手动将开头的命令部分，中间各个文件下载的文件数据，结尾命令部分分离依次对比，其中中间文件较多，全部进行对比比较耗时耗力，所以对于每组测试，仅随机抽取其中两个文件的数据进行对比，结果对于波特率为9600的测试数据，除了连接命令以及文件数据中填充部分不同（格式相同，对结果没有影响），其他的发送指令和文件数据都是相同的，对于波特率为115200的测试数据，除了上述不影响结果的连接命令和文件数据填充部分不同，还有屏幕的响应有所区别，VisualTFT软件下载时，每次发送一个文件数据包，屏幕会返回一次包含(sn+1)和~(sn+1)的应答包，但是在代码下载的过程中，屏幕返回了三次该应答包，最后最终结果，两者都成功将工程文件下载到了屏幕中，屏幕的显示结果也是相同的。

   

   ![image-20210830103133922](C:\Users\11547\AppData\Roaming\Typora\typora-user-images\image-20210830103133922.png)

2. 特定图片的更新

   由于VistualTFT中暂时没有更新单个图片的功能，故仅仅测试代码下载单个图片，测试结果将与预测的结果进行对比，该测试将选择第一个画面中编号为0的图片替换为准备好的另一张图片，即只要测试结果为仅此张图片被替换即可。经过测试，图片成功进行替换。

##### 事件响应一致性分析

该工程中的第一个画面含有账号密码登录按钮，事件响应即是点击该按钮后屏幕的变化情况以及返回应答包的数据，经过点击操作后，两种下载方法有相同的事件响应，当点击按钮后，屏幕跳转到输入账号密码的界面，且返回EE B1 11 00 01 00 04 10 01 01 FF FC FF FF应答包。

#### 效率分析

##### 下载时间

测试时间的方法是直接在程序中加入timeval结构体，可精确到微秒

使用VisualTFT软件下载整个工程且波特率为9600的下载时间约为1h23min42s，当提升波特率为115200时，时间约为9min38s

使用代码下载整个工程且波特率为9600的下载时间约为1h22min45s，当提升波特率为115200时，时间约为1h22min21s

使用代码下载特定的五张图片，并使用了9600和115200两种波特率进行测试，结果如下：

![image-20210913132209033](C:\Users\11547\AppData\Roaming\Typora\typora-user-images\image-20210913132209033.png)

### 结论

在下载结果上看，代码下载方法和使用VisualTFT都可以下载成功，且通过串口收发的数据一致，下载完成的屏幕也可正常使用，两者拥有相同的事件响应，就下载过程来看，虽然文件下载的顺序不同，但是这个对最终结果没有影响，另外，当下载波特率在9600时，两者所需要的时间几乎相同，在下载波特率为115200时，使用VisualTFT软件下载速度有明显的加快，但是使用代码下载的速度几乎没有加快，初步判断为代码延时逻辑的问题。总体来看，用代码下载和用VisualTFT软件下载的效果相同，效率上，代码下载略逊一筹，但是花费时间也在可接受的范围内，且代码下载方法拥有更好的可扩展性。

