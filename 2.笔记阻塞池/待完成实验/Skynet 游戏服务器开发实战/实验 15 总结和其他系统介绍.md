# 实验介绍

本节实验中，首先会回顾之前实验所讲到的知识点，然后提出了游戏开发中会遇到的其他玩法系统，并给出了大致的实现方案。

#### 知识点

- 回顾前面的实验
- 其他玩法系统

# 回顾前面的实验

得益于 skynet 这么好的框架，游戏服务器开发无需从零开始，只需要简单的扩展就能开始写游戏逻辑。

前面的实验从最基础的 skynet 编译运行开始，然后设计最简单的游戏服务器架构，从 RPC 协议，数据库数据，内存数据，Excel 配置数据，再到玩法逻辑。通过循序渐进和实战的方式学习游戏服务器开发。

然后学习了一些服务器开发过程中用到的通用模块，如定时器，事件分发，模糊搜索，日志处理等等。

学习完这些基础实验之后，应该就算入门游戏服务器开发了。这些实验没有涉及过多的游戏服务器架构设计，都是采用单个服务来处理业务。

回顾前面的实验，整理出一份思维导图如下：

![回顾](https://doc.shiyanlou.com/courses/2770/1456966/9eafe42ad8b7943e0acdf2bdf0e1cea6-0)

# 其他玩法系统

游戏服务器开发有哪些内容在第一个实验也介绍了，还有许多玩法系统还没有去实现，而又是一般的网络游戏都具有的。比如任务系统，好友系统，公会系统，聊天系统这些，下面是对这些系统的实现给出一些参考意见。

#### 聊天系统

聊天系统的实现有两种方案，一种是直接接入第三方的 IM 服务，这样对于小型的游戏开发比较快，无需服务器过多的干涉，工作量基本在客户端。

当然，一般的游戏开发公司都是自己实现聊天服务器的，使用 skynet 也能很方便的实现一个独立的聊天服务。可以采用 skynet 提供的 cluster 模块，把聊天服务的进程独立出来。至于架构方面的话，看聊天系统的需求，可以一个聊天室一个 skynet 服务。客户端需要为聊天单独维持一个 socket 链接。

游戏中的聊天系统都会有世界频道这个功能，就是一个全局的聊天室，只有在线的玩家才能收到消息，所以按聊天室来区分 skynet 服务的话，可以比较简单的处理广播消息。

游戏中的滚屏公告也可以并入到聊天系统一起做的，可以归类到世界频道。

#### 好友系统

好友系统的实现可以采用数据冗余的方式存储，一般游戏里的好友数量不会很多。因此会把好友数据都记录在玩家身上，比如头像等级这些信息。就像微信一样，好友换头像了不会立即刷新，要点开详情才会去刷新。

当然一些需要及时刷新的也是得刷新的，一般会采用玩家离线的时候把需要刷新的数据推送给所有好友那边去同步数据。

#### 道具背包

道具和背包是分不开的两个功能，一般游戏里会有多个背包，每个背包里会有多种道具。而道具又会区分有格子的和没格子的两种，有格子概念的道具是指，当一个道具叠加数量超出上限后，需要另起一个格子来存放道具，这种道具需要为它生成动态 ID 。没有格子概念的道具是指道具数量理论上可以无限叠加，超出理论上限后不允许增加，这种道具不用为每个道具分配格子，只需要存储道具的配置 ID 和数量即可。

在实现上，一般会在登录时下发所有道具给客户端，然后中途变化就推送变化的数据给客户端。这样客户端就可以缓存住道具数据，在需要判断道具是否足够的地方直接取本地缓存即可。

#### 任务系统

任务系统在事件模块的实验中有提到实现方案，任务按照任务类型分好类，一个种任务监听一个事件，比如任务要求是达到多少级，就监听升级的事件，具体多少级放到 Excel 配表里配置即可。

玩家身上只需要存任务的 ID ，进度以及状态即可，任务总进度可以读取配置表，状态可以区分未完成，已完成未领取奖励，已完成已领取奖励。

另外还有很多活动玩法都会使用到任务系统，所以任务存放的数据还需要支持每个任务存放其他额外的数据。比如有个活动需要记录任务做到第几轮了，那么任务数据里需要额外记录一个轮数。

#### 商店

商店是指使用游戏里的货币购买其他道具的系统，一般实现的时候需要考虑通用性，一个游戏里都会有多种商店，商店的开放等级和时间都会有不同的限制。但卖东西的本质是一样的，且都是只卖系统给出的道具。

还需要考虑商品的限购，刷新等功能。一般这些功能都会抽出配置到 Excel 里面，这样增加一个商店不需要改代码，还能控制商品的限购和什么时候刷新商品。

#### 充值

充值包含了用钱买游戏种的货币和礼包的情况，实现充值模块也要考虑通用性的情况。充值在游戏服务器中就是处理发货的这一步骤，收到 SDK 的发货请求要处理好补单的情况，要判断订单的状态是否已经发货。

游戏活动中都会包含各种充值礼包，充值模块实现的好，礼包活动实现就简单。实现礼包活动逻辑时不用去理会充值订单相关的问题，只需要专门处理好发货就行。

#### 排行榜

排行榜在游戏中是很常见的，而且一个游戏都会有各种各样的排行榜。所以可以实现一个通用的排行榜模块，其他玩法需要使用排行榜的时候就只要调用接口就行。

在 skynet 中实现排行榜可以引入 [xjdrew/lua-zset](https://github.com/xjdrew/lua-zset) 库，这个库的代码是从 redis 源码中抽出来的，专门用来排序的。这个排序只是内存中排序的，排行榜上的数据还需要自行做好存数据库的功能。

有些游戏的排行榜会直接使用 redis 来排序，方案也是可以的。

#### 公会系统

公会系统是游戏中比较大的一个系统了，涉及到多人的逻辑。公会系统需要处理好公会的基础功能，比如加入和离开公会这些。除了公会的基本功能，还有有很多的公会玩法。

公会系统的数据要做好区分，主要有下面几种数据：

- 公会的公共数据，比如公会名字，公会等级
- 公会里玩家数据，比如职位
- 玩家身上的公会相关数据

公会的公共数据还包含了公会玩法的公共数据，公会里的玩家数据还会存放玩家玩公会玩法里的一些数据，这些数据在玩家离开公会时会清空。所以如果有公会相关的数据需要在玩家离开公会时不清空则需要把数据记录到玩家身上。

# 实验总结

在本节实验中，回顾了前面实验中学到的知识点，也介绍了游戏开放中遇到的其他玩法系统的实现方案，当然游戏玩法很定不止这些的。这些实验的实现都是基于 skynet 来实现的，但是没有用到 skynet 过多的特性，如果想了解 skynet 的来龙去脉，以及历史 BUG 和某些原理机制，可以去读 [云风的博客](https://blog.codingnow.com/eo/skynet/) 。

如果想分析 skynet 的源码，我推荐去读下 [Manistein's Blog](http://manistein.club/) 的两篇文章：

- [skynet 源码赏析](http://manistein.club/post/server/skynet/skynet源码赏析/)
- [skynet 网络机制](http://manistein.club/post/server/skynet/skynet网络机制/)