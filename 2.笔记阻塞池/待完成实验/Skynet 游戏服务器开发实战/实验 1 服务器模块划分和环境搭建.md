# 实验介绍

在本节实验中，将会了解到游戏服务器包含哪些模块，也能了解到跟后台相关的几个模块，以及这些模块的作用是什么。并且练习如何搭建游戏服务器开发环境，为下一个实验做好准备工作。

#### 知识点

- 游戏服务器模块划分
- 游戏服务器引擎 skynet 介绍
- 开发环境搭建

# 游戏服务器模块划分

一个游戏服务器从游戏逻辑方面可以分为下面几个模块：

- 注册和登录
- 网络协议
- 数据库
- 玩法逻辑
- 其他通用模块

除了游戏逻辑方面的划分，实际开发过程中还会有其他几个重要的工具类模块：

- Excel 配置导表工具
- GM 指令
- 测试机器人
- 服务器打包部署工具

这里也介绍下游戏后台跟游戏服务器相关几个模块，这个是游戏运营后台开发人员负责的，游戏服务器开发人员了解下就可以：

- 公告系统
- 邮件系统
- 活动系统
- 礼包系统
- 运营日志

# 按游戏逻辑划分

#### 注册和登录

注册和登录是一个游戏的入口，一般游戏开发中把注册和登录做在一起的。这点和网站后台开发有点不同，因为游戏账户的注册都是由第三方平台提供 SDK 的，游戏开发过程中只要做好登录逻辑即可。游戏开发后期决定用哪个运营平台的时候才会去考虑接入平台提供的 SDK。登录流程可以参考下面这个时序图：

![注册登录时序图](https://doc.shiyanlou.com/courses/2770/1456966/5cb63e343ea97a0c0a73508a148ce35e-0)

#### 网络协议

网络协议在这里不是指 TCP 或者 HTTP 这些，而是在这之上的应用层协议。这里的网络协议是用于游戏中的客户端和服务器交流的。其中用的最多的就是 Google 的 [Protocol Buffers](https://github.com/protocolbuffers/protobuf) 了，也有直接用 [JSON](https://www.json.org/json-zh.html) 或者 [MessagePack](https://msgpack.org/) 的，区别就是有模式 (schema) 和无模式 (schema-less) 。另外也推荐看看 [云风](https://blog.codingnow.com/) 基于 google protocol buffer 简化的一种新的协议 [sproto](https://blog.codingnow.com/2014/07/ejoyproto.html) ，这是游戏引擎 [skynet](https://github.com/cloudwu/skynet) 自带的一套网络协议。

#### 数据库

早期的游戏服务器是没有使用数据库的，玩家的数据直接存文件的，一个玩家一个数据文件。现代的游戏服务器都配备了数据库，是因为游戏越来越复杂，数据量也越来越多，而且采用数据库也方便对数据的管理和备份。

数据库的选取一般跟游戏项目无关，跟开发者的习惯和经验有关。市面上用的游戏用到的数据库大多是下面这几种：

- MySQL
- MongoDB
- Redis

数据库在游戏服务器中的作用主要就是落地玩家和玩法相关的数据，游戏开发中并不会依赖于数据库是关系型数据库还是非关系型的数据。一般建议采用 MongoDB 作为游戏数据库，因为在游戏开发过程中用到的数据结构用的最多的就是 dict 类型的，跟 MongoDB 的数据结构（采用的是 [BSON](http://bsonspec.org/) ）类似。而且版本迭代的过程中，不像 SQL 一样需要去修改表结构。Redis 一般用作为内存数据库，实际开发过程中都是结合 MySQL 来使用的比较多。

除了上面介绍的这些数据库，还需要了解下内存缓存（也有称为内存数据库的）这个概念。比如玩家登录成功后，玩家的数据是要缓存到内存中的，方便快速对数据的修改。玩家下线后也不会立即清除缓存，方便短时间内重登可以快速读取到玩家的数据。

#### 玩法逻辑模块

下面是游戏开发中常见的玩法模块，一般的游戏都会包含这些玩法。可能不同的游戏，玩法名字会有所不同。

- 背包系统
- 装备系统
- 英雄系统
- 任务系统
- 推图副本
- 战斗系统
- 活动管理
- 内币商店
- 充值（外币商店）
- 单人竞技场
- 多人竞技场
- 公会系统
- 好友系统
- 聊天系统
- 邮件系统
- 新手指引
- 红点管理

#### 其他通用模块

下面这些模块是辅助开发上面介绍的玩法逻辑模块用的，比如聊天需要用到敏感词检测，好友或者公会搜索会使用到模糊搜索。

- 定时器
- 事件分发
- 离线消息队列
- 批处理队列
- 敏感词检测
- 模糊搜索
- 游戏日志系统
- 运营日志系统

#### 工具类模块

工具类模块在游戏开发中也是必不可少的，下面列出了常用的一些工具：

- Excel 配置导表工具
- GM 指令
- 测试机器人
- 服务器打包部署工具

最常见的就是 Excel 配置导表工具了，是用于将策划配置的 Excel 表格转换成代码中能方便使用的数据结构。比如 Python 的 dict 结构，Lua 的 table 结构等等。

GM 指令主要是用来做玩法测试的，比如新建了一个账号，不用从头开始练级，可以直接用指令修改等级和发放道具。

测试机器人主要是在服务器开发过程中使用的，因为在开发的过程中，客户端和服务端只是先商定了交互协议。在客户端还没有制作完需求功能的时候需要使用测试机器人来测试自己的代码逻辑，类似于 [Postman](https://www.postman.com/) 这类测试接口的工具。测试机器人还有另外一个用途就是模拟正常玩家来压测服务器。

服务器打包部署工具也是必要的，一般就是打包和加密游戏服务器代码的脚本。做成一键部署的脚本可以更方便运维他们更快的部署服务器。

#### 游戏后台相关模块

后台一般是运营团队开发的。下面列举了几个跟游戏服务器有关联的后台模块：

- 公告系统
- 邮件系统
- 活动系统
- 礼包系统
- 运营日志

公告系统是用于在后台配置游戏中的公告。公告一般有两种，一种是用于停服维护的时候在登录界面显示的公告，一种是用于在游戏中滚动显示的公告。根据游戏类型决定需求的，有些游戏没有滚屏公告的。

邮件系统是用于客服发全服邮件或者单人邮件给玩家用的，游戏服务器提供对应的接口给后台发邮件就行。

活动系统是用于运营配置服务器活动开放时间用的。礼包系统是用来配置礼包兑换码的。运营日志是用来查看游戏中输出的打点日志的，做数据统计和分析用的。

#### 游戏服务器引擎 skynet 介绍

skynet 是一个轻量级的为在线游戏服务器打造的框架。如何使用可以参考官方的 [wiki](https://github.com/cloudwu/skynet/wiki)，后续课程的例子都是基于这套框架上实现的，可以把它比作于 web 开发框架里的 [Openresty](https://openresty.org/cn/) 或者 [Flask](https://palletsprojects.com/p/flask/) 等等。

skynet 服务器引擎的特点：

- 开源且作者持续维护
- `Actor` 模式
- 多线程
- 多进程，内置 `cluster` 集群

更多关于 skynet 的资料可以阅读下 [云风的博客](https://blog.codingnow.com/eo/skynet/) ，里面有介绍 skynet 从出生开始的相关历史和疑难杂症。

# 开发环境搭建

#### 下载引擎

打开桌面上的 Xfce 终端，先创建好工程目录：

```bash
cd Code
mkdir server
cd server
```

下载引擎需要用到 git，把 skynet 代码 clone 下来。

```bash
git clone https://github.com/cloudwu/skynet.git
```

也可以参考下面这个截图里进行命令操作。

![下载引擎代码](https://doc.shiyanlou.com/courses/2770/1456966/b001521c915a5730bdd78d646e8237d2-0)

完成后的工程目录结构这样的：

```txt
Code
└── server
    └── skynet
```

#### 编译

进入到 skynet 目录，执行 `make linux` 进行编译操作：

```bash
cd skynet
make linux
```

![编译引擎](https://doc.shiyanlou.com/courses/2770/1456966/caaaeb6b6f9d4f6f4f1d816c6d6b34f3-0)

#### 运行 Demo

编译成功之后，执行 `./skynet examples/config` 启动服务器：

```bash
./skynet examples/config
```

运行效果如下：

![运行 Demo](https://doc.shiyanlou.com/courses/2770/1456966/193df1a4d5572a7dde90c8eb3bdac6e4-0)

# 实验总结

在本节实验中，我们学习了游戏服务器有哪些模块，以及这些模块的作用。对于游戏服务器开发有了个大致的了解后，接着练习了如何部署开发环境。