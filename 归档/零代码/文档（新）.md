# 5. 相关工作和系统评估实验与分析

**本节的主要目的是：**

该阶段的目标是实现和大彩软件VisualTFT同样的串口更新功能，具体任务是将屏幕的工程文件下载到屏幕上，下载完成后，屏幕应当正常运行工程的各种功能，下载的文件分为两种，一种是整个工程的更新，另一种是特定资源的更新。 

## 5.1 实验环境

### （a）拓扑结构

以下为实验环境的网络拓扑结构，Arm-Linux板子作为中间件连接屏幕和服务器。

![零代码网络拓扑结构图](C:\Users\11547\Downloads\零代码网络拓扑结构图.png)

### （b）硬件环境

|      | 硬件       | 型号                          |
| ---- | ---------- | ----------------------------- |
| 1    | 嵌入式MCU  | Arm9 128M                     |
| 2    | HMI        | ARM Cortex M3                 |
| 3    | 后台服务器 | CentOS Linux release 7.6.1810 |
| 4    | 屏幕       | 医用级DC80480M070_2111_OT     |

### （c）相关软件使用和对应平台

**相关软件使用和对应平台** 

   首先，进行串口更新的两种方法分别是使用VisualTFT软件和使用C语言代码编写下载逻辑，其中 VisualTFT软件为大彩公司提供的配套软件，在Win10系统运行，而C语言代码则在Win10系统下Ubuntu虚拟机中编译运行。测试辅助软件为BusHound，该软件为大彩提供的串口数据抓取软件，便于对串口数据进行分析。一致性数据对比软件使用Beyond Compare，该软件可以便于对文本数据进行对比。 

|      | 软件             | 名称/版本              |
| ---- | ---------------- | ---------------------- |
| 1    | 开发环境         | X86 intel windows      |
| 2    | 虚拟机软件       | VMware Workstation Pro |
| 3    | 虚拟机操作系统   | Ubuntu 20.04.3         |
| 4    | 大彩工程下载软件 | VirtualTFT 3.0.0.1185  |
| 5    | 后台操作系统     | Centos 16.06           |
| 6    | 串口数据抓取软件 | BusHound               |
| 7    | 数据对比软件     | Beyond Compare         |

### （d）HMI工程

**下载工程文件和图片文件** 

测试的工程为远鸿_project，该工程适合七寸屏幕，共包含十一个工程画面，编译后的文件结构如下图 

![image-20210828165042726](C:\Users\11547\AppData\Roaming\Typora\typora-user-images\image-20210828165042726.png)       

测试图片下载的工程仅有一个画面只包含一张图片，该图片的id为0，替换的图片有六张，其大小分别为5832 bytes, 19608 bytes, 115363 bytes, 219647 bytes, 383188 bytes, 2609075 bytes。

测试的音频文件有两个，其大小分别为1109816 bytes和24032350 bytes。

## 5.2实验主要流程

对于使用VisualTFT软件下载，只需要将工程文件导入软件中，通过图形化界面操作编译下载即可。

对于使用C语言代码下载，需要将下载流程可归纳为三个部分，即打开串口文件，以及串口数据的发送与接收，其中默认发送的串口数据的波特率为9600，故使用open函数打开串口文件时填入的波特率参数为9600，发送数据即可直接使用write函数对串口进行操作，接收数据可用read函数直接进行数据读取。

### （a）下载前的准备

首先需要做下载前的准备工作，即发送串口连接确认的命令，如果连接成功，设备会返回连接成功的确认包，并且发出“滴”一声，接着如果是下载整个工程，则可以加入格式化的命令，将屏幕之前的工程文件清除，之后下载前需要发送字符串axrcekgdyhtsunqwpjbvifomzl使屏幕切换到大彩指令模式。

### （b）文件遍历

需要对文件夹中的所用文件进行下载，所以需要使用递归遍历所有文件夹，当查找到文件时，开始对应的文件下载。

### （c）文件下载

随后即可发送文件下载的命令，下载命令以EE FB开头，接着是下载包的大小（取2052，2个字节，高位在前），波特率（如果提升波特率，则填写相应波特率/100，2个字节，高位在前，如果不修改当前波特率，则设置为0），文件大小（4个字节，高位在前），文件在屏幕中存放的路径（以"3:"开头，如"2:/bin/image.bin"），校验码（CRC16，校验从FB开始的数据），以FF FC FF FF结尾，发送完该命令后，等待屏幕返回的下载确认应答，紧接着即可发送文件数据，将文件数据分成多个数据包发送，每个数据包大小为2052个字节，其中前两位为sn和~sn，用来标明数据包的序列号，每次发送完成，等待应答字节(sn+1)和~(sn+1)。等待全部文件下载完成后，发送下载完成指令，结束工程更新。

### （d）编译运行

C语言代码编写好后，使用gcc编译运行。

## 5.3 实验1：工程更新一致性实验

一致性分析是指在主要功能和使用方面，分析用代码下载和用VisualTFT软件下载是否相同，其又分成两个方面，一个是下载一致性，即工程文件的下载过程是否相同以及测试是否都可下载成功，另一个是事件响应一致性，即下载成功后，屏幕功能是否可以正常使用，使用结果是否相同。对于整个工程的更新和图片的更新，每个测试都使用了两种波特率——9600和115200，每种波特率测试三组数据进行对比。 

在整个工程的更新中，包括了文件下载的顺序，数据下发，最终结果的一致性，首先对于文件的下载顺序，经过几次测试，使用VisualTFT软件下载，每次文件下载顺序都是相同的，使用代码下载，每次下载顺序也是不变的，但是两者的文件下载顺序并不相同，经测试证明，工程最终的下载结果与文件下载的顺序没有关系，故下载顺序不同没有影响。对于数据的下发，使用Bus Hound软件进行串口数据的抓取导出为文本文件后，使用Beyond Compare软件进行文本对比，由于两者下载顺序的不同，不能简单地对比整个文本，手动将开头的命令部分，中间各个文件下载的文件数据，结尾命令部分分离依次对比，其中中间文件较多，全部进行对比比较耗时耗力，所以对于每组测试，仅随机抽取其中两个文件的数据进行对比，结果发现，对于波特率为9600的测试数据，除了连接命令以及文件数据中填充部分不同（格式相同，对结果没有影响），其他的发送指令和文件数据都是相同的，对于波特率为115200的测试数据，除了上述不影响结果的连接命令和文件数据填充部分不同，还有屏幕的响应有所区别，VisualTFT软件下载时，每次发送一个文件数据包，屏幕会返回一次包含(sn+1)和~(sn+1)的应答包，但是在代码下载的过程中，屏幕返回了三次该应答包， 最后最终结果，两者都成功将工程文件下载到了屏幕中，屏幕的显示结果也是相同的。另外对于事件响应一致性，经过对比按钮点击后返回的数据包以及屏幕的反应，两种方法的下载结果是相同的，通过事件响应一致性测试。

## 5.4 实验2：工程更新性能实验

由于使用9600波特率下载工程较慢，需要一个多小时，测试数据耗时耗力，且无实际参考意义，所以本次工程更新仅采用115200波特率，下表为测试工程下载的时间：

|           | 1         | 2      | 3          | 4        | 5        | 6        | 7        | 8        | 9        | 10         | 平均     |
| --------- | --------- | ------ | ---------- | -------- | -------- | -------- | -------- | -------- | -------- | ---------- | -------- |
| 时间（s） | 602.25855 | 594.69 | 594.670939 | 594.3966 | 595.3682 | 594.7234 | 595.8996 | 595.4274 | 596.7335 | 594.815939 | 595.8984 |

## 5.5 实验3：工程资源更新性能实验

下表为不同图片大小在不同两种不同波特率下更新所用的时间

| 图片大小(bytes) | 波特率 | 1        | 2           | 3        | 4        | 5        | 6        | 7        | 8        | 9          | 10       | 平均     |
| --------------- | ------ | -------- | ----------- | -------- | -------- | -------- | -------- | -------- | -------- | ---------- | -------- | -------- |
| 5832            | 9600   | 12.19643 | 12.229885   | 12.37145 | 12.2637  | 12.44484 | 12.32318 | 12.44521 | 12.21332 | 12.35      | 12.20523 | 12.30432 |
|                 | 115200 | 6.593378 | 6.463115    | 6.524656 | 6.464141 | 6.560503 | 6.478104 | 6.461351 | 6.485327 | 6.474383   | 6.30045  | 6.480541 |
| 19608           | 9600   | 27.646   | 27.731619   | 27.67063 | 27.78359 | 27.56377 | 27.75934 | 27.57576 | 27.68042 | 27.611379  | 27.36312 | 27.63856 |
|                 | 115200 | 8.230157 | 8.303304    | 8.328202 | 8.126203 | 8.278766 | 8.293349 | 8.16283  | 8.333335 | 8.323725   | 8.25643  | 8.26363  |
| 115363          | 9600   | 130.594  | 130.787668  | 130.9062 | 130.6751 | 130.4936 | 130.5467 | 130.616  | 130.8402 | 130.760659 | 130.6522 | 130.6872 |
|                 | 115200 | 20.36379 | 20.410004   | 20.33489 | 20.34942 | 20.31842 | 20.34711 | 20.49793 | 20.34288 | 20.422837  | 20.35472 | 20.3742  |
| 219647          | 9600   | 242.4103 | 242.448675  | 242.5862 | 242.1815 | 242.7048 | 242.8219 | 242.4817 | 242.2223 | 242.530244 | 242.2453 | 242.4633 |
|                 | 115200 | 33.10691 | 33.2565     | 33.12474 | 32.93992 | 32.95765 | 33.07345 | 33.10881 | 33.05889 | 32.99353   | 33.02435 | 33.06447 |
| 383188          | 9600   | 417.5114 | 417.600841  | 417.6027 | 417.547  | 417.2217 | 417.5596 | 417.9507 | 417.5719 | 417.564521 | 417.24   | 417.537  |
|                 | 115200 | 53.18209 | 53.299543   | 58.08131 | 53.30734 | 53.21034 | 53.06649 | 53.36665 | 53.25308 | 53.066412  | 53.67543 | 53.75087 |
| 2,609,075       | 9600   | 2804.653 | 2804.398797 | 2804.986 | 2804.484 | 2804.529 | 2804.388 | 2804.769 | 2804.628 | 2804.3982  | 2804.438 | 2804.567 |
|                 | 115200 | 327.262  | 326.849183  | 326.9845 | 327.3488 | 326.9438 | 327.2324 | 327.1654 | 326.8976 | 327.134321 | 326.9837 | 327.0802 |

![image-20210916203350820](C:\Users\11547\AppData\Roaming\Typora\typora-user-images\image-20210916203350820.png)

由于声音文件一般也较大，所以和工程更新一样，仅测试波特率在115200时的时间:

| 声音文件大小(bytes) | 1         | 2        | 3           | 4        | 5        | 6        | 7        | 8        | 9        | 10        | 平均     |
| ------------------- | --------- | -------- | ----------- | -------- | -------- | -------- | -------- | -------- | -------- | --------- | -------- |
| 1109816             | 141.14464 | 140.9884 | 141.23312   | 140.7823 | 141.3873 | 140.8983 | 141.0034 | 141.1293 | 141.1825 | 141.6944  | 141.1444 |
| 24032350            | 322.79734 | 324.8996 | 323.7979302 | 319.3989 | 322.1839 | 322.8635 | 323.7863 | 322.74   | 322.7394 | 323.38944 | 322.8596 |

## 5.6 实验4：事件响应实验

事件响应测试以下载按钮点击事件测试，屏幕会讲信息发送给Arm-Linux板子，Arm-Linux板子会将信息发送给服务器，服务器收到信息并处理后，会向Arm-Linux板子发送下载命令，Arm-Linux收到后便会执行下载程序。本次实验通过测试Arm-Linux板子从发出信息到收到服务器命令这段时间的延时来反应事件响应性能，具体流程如下图所示：

![零代码网络拓扑结构图-Page-3.drawio](C:\Users\11547\Downloads\零代码网络拓扑结构图-Page-3.drawio.png)

|                  | 1     | 2       | 3      | 4      | 5       | 6     | 7       | 8      | 9      | 10     | 平均     |
| ---------------- | ----- | ------- | ------ | ------ | ------- | ----- | ------- | ------ | ------ | ------ | -------- |
| T2+T3+T4（微秒） | 6735  | 57295   | 5623   | 4812   | 123464  | 75629 | 80094   | 11813  | 21025  | 8457   | 39494.7  |
| T3(微秒)         | 739.3 | 23192.7 | 2027.3 | 1312.8 | 99217.3 | 35140 | 38492.5 | 7034.5 | 4545.6 | 3372.4 | 21507.44 |

## 5.7 实验5：HMI嵌入式代码减少量实验

零代码的最大的特点就是减少了嵌入式代码的编写，

|       | 嵌入式编程 | HMI零代码 | 减少量 |
| ----- | ---------- | --------- | ------ |
| 工程1 | 13200      | 3000      | 80%    |
| 工程2 |            |           | 79%    |



## 5.8 实验6：HMI嵌入式代码开发周期

问卷。

